- name: Configure network interfaces with netplan
  ansible.builtin.copy:
    dest: /etc/netplan/50-cloud-init.yaml
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          {{ router.admin }}:
            dhcp4: false
            addresses:
              - {{ router.admin_ip }}/{{ router.admin_subnet }}
            optional: true
          {{ router.wan }}:
            dhcp4: true
          {{ router.lan_home }}:
            dhcp4: false
            addresses:
              - {{ router.lan_home_ip }}/{{ router.lan_home_subnet }}
            optional: true
          {{ router.lan_lab }}:
            dhcp4: false
            addresses:
              - {{ router.lan_lab_ip }}/{{ router.lan_lab_subnet }}
            optional: true
    owner: root
    group: root
    mode: "0600"

- name: Apply netplan
  ansible.builtin.command: netplan apply
  changed_when: true

- name: Install packages for Linux router
  ansible.builtin.apt:
    name:
      - nftables
      - traceroute
      - tcpdump
      - dnsmasq
      - hostapd
    state: present
    update_cache: yes

- name: Enable IPv4 forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    reload: true
    sysctl_set: true

- name: Configure dnsmasq for local DNS cache
  ansible.builtin.copy:
    dest: /etc/dnsmasq.conf
    content: |
      # Listen on the LAN interface only
      interface={{ router.lan_home }}
      #interface={{ router.lan_lab }}
      bind-interfaces
      no-dhcp-interface={{ router.wan }}

      # Set up DNS cache
      cache-size=10000

      # Use upstream DNS servers
      server=8.8.8.8
      server=8.8.4.4

      # Never forward plain names (without a dot or domain part)
      domain-needed

      # Never forward addresses in the non-routed address spaces
      bogus-priv

      # DHCP range for LAN
      dhcp-range={{ router.lan_home }},{{ router.lan_home_range }},{{ router.lan_home_mask }},24h
      #dhcp-range={{ router.lan_lab }},{{ router.lan_lab_range }},{{ router.lan_lab_mask }},24h

      # Gateway
      dhcp-option=tag:{{ router.lan_home }},3,{{ router.lan_home_ip }}
      #dhcp-option=tag:{{ router.lan_lab }},3,{{ router.lan_lab_ip }}

      # DNS server
      dhcp-option=tag:{{ router.lan_home }},6,{{ router.lan_home_ip }}
      #dhcp-option=tag:{{ router.lan_lab }},6,{{ router.lan_lab_ip }}
    owner: root
    group: root
    mode: "0600"
  notify: Restart dnsmasq

- name: config nftables
  ansible.builtin.copy:
    dest: /etc/nftables.conf
    content: |
      #!/usr/sbin/nft -f

      flush ruleset

      # Define variables for interfaces
      define WAN_IF = {{ router.wan }}
      define LAN_HOME_IF = {{ router.lan_home }}
      define LAN_HOME_NET = {{ router.lan_home_net }}/{{ router.lan_home_subnet }}
      define LAN_LAB_IF = {{ router.lan_lab }}
      define LAN_LAB_NET = {{ router.lan_lab_net }}/{{ router.lan_lab_subnet }}

      table ip filter {
          chain input {
              type filter hook input priority 0; policy drop;

              # Allow established/related connections
              ct state established,related accept

              # Allow loopback
              iifname "lo" accept

              # Allow LAN to access router
              iifname { $LAN_HOME_IF, $LAN_LAB_IF } accept

              # Allow ICMP from WAN (for ping)
              iifname $WAN_IF icmp type echo-request accept

              # Drop invalid connections
              ct state invalid drop
          }

          chain forward {
              type filter hook forward priority 0; policy drop;

              # Allow established/related connections
              ct state established,related accept

              # Allow LAN to WAN
              iifname $LAN_HOME_IF oifname $WAN_IF accept
              iifname $LAN_LAB_IF oifname $WAN_IF accept

              # sample port forwarding
              tcp dport 8080 accept

              # Drop invalid connections
              ct state invalid drop
          }

          chain output {
              type filter hook output priority 0; policy accept;
          }
      }

      table ip nat {
          chain prerouting {
              type nat hook prerouting priority -100; policy accept;

              # sample port forwarding
              tcp dport 8080 dnat to 192.168.10.248:8080
          }

          chain postrouting {
              type nat hook postrouting priority 100; policy accept;

              # Masquerade LAN to WAN
              oifname $WAN_IF ip saddr $LAN_HOME_NET masquerade
              oifname $WAN_IF ip saddr $LAN_LAB_NET masquerade
          }
      }
  notify: Restart nftables
