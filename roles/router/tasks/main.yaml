- name: Configure network interfaces with netplan
  ansible.builtin.copy:
    dest: /etc/netplan/50-cloud-init.yaml
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          {{ router.wan }}:
            dhcp4: false
            addresses:
              - 192.168.1.55/24
            nameservers:
              addresses:
                - 192.168.1.254
            gateway4: 192.168.1.254
          {{ router.lan_home }}:
            dhcp4: false
            addresses:
              - {{ router.lan_home_ip }}/{{ router.lan_home_subnet }}
    owner: root
    group: root
    mode: "0600"

- name: Apply netplan
  ansible.builtin.command: netplan apply
  changed_when: true

- name: Install packages for Linux router
  ansible.builtin.apt:
    name:
      - nftables
      - traceroute
      - tcpdump
      - dnsmasq
      - hostapd
    state: present
    update_cache: yes

- name: Configure dnsmasq for local DNS cache
  ansible.builtin.copy:
    dest: /etc/dnsmasq.conf
    content: |
      # Listen on the LAN interface only
      interface={{ router.lan_home }}
      bind-interfaces
      no-dhcp-interface={{ router.wan }}

      # Set up DNS cache
      cache-size=10000

      # Use upstream DNS servers
      server=8.8.8.8
      server=8.8.4.4

      # Never forward plain names (without a dot or domain part)
      domain-needed

      # Never forward addresses in the non-routed address spaces
      bogus-priv

      # DHCP range for LAN
      dhcp-range={{ router.lan_home_range }},{{ router.lan_home_mask }},24h

      # Gateway
      dhcp-option=3,{{ router.lan_home_ip }}

      # DNS server
      dhcp-option=6,{{ router.lan_home_ip }}
    owner: root
    group: root
    mode: "0600"
  notify: Restart dnsmasq
